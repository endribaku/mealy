@startuml Meal Planner Engine - Database Schema

!theme plain
skinparam linetype ortho

title Meal Planner Engine - Database Schema (Supabase PostgreSQL)

entity "users" {
  **Primary Key**
  --
  * id : UUID <<PK>>
  --
  **Core Fields**
  --
  * email : TEXT <<UNIQUE>>
  * name : TEXT
  * diet : TEXT
  * is_active : BOOLEAN
  --
  **JSONB Columns**
  --
  * profile : JSONB
    â”œâ”€ email
    â”œâ”€ name
    â”œâ”€ diet
    â”œâ”€ allergies[]
    â”œâ”€ calorieTarget
    â”œâ”€ cookingSkill
    â”œâ”€ householdSize
    â”œâ”€ measurementSystem
    â”œâ”€ goals[]
    â”œâ”€ preferences{}
    â”œâ”€ createdAt
    â””â”€ updatedAt
  --
  * learned_preferences : JSONB
    â”œâ”€ dislikedIngredients[]
    â”œâ”€ dislikedCuisines[]
    â”œâ”€ favoriteCuisines[]
    â”œâ”€ favoriteIngredients[]
    â”œâ”€ spiceLevel
    â”œâ”€ preferredComplexity
    â”œâ”€ patterns{}
    â””â”€ lastUpdated
  --
  * metadata : JSONB
    â”œâ”€ totalMealPlansGenerated
    â”œâ”€ totalMealsGenerated
    â”œâ”€ totalRegenerations
    â”œâ”€ totalRatings
    â”œâ”€ averageRating
    â”œâ”€ totalMealsCooked
    â”œâ”€ totalRecipesViewed
    â”œâ”€ lastLoginAt
    â”œâ”€ lastMealPlanAt
    â”œâ”€ createdAt
    â””â”€ updatedAt
  --
  * dietary_restrictions : JSONB
    â”œâ”€ allergies[]
    â”‚  â”œâ”€ name
    â”‚  â”œâ”€ severity
    â”‚  â””â”€ notes
    â”œâ”€ intolerances[]
    â””â”€ medicalConditions[]
  --
  * subscription : JSONB
    â”œâ”€ tier
    â”œâ”€ status
    â”œâ”€ expiresAt
    â””â”€ features[]
  --
  * notifications : JSONB
    â”œâ”€ email
    â”œâ”€ push
    â”œâ”€ sms
    â””â”€ preferences{}
  --
  **Timestamps**
  --
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
  --
  **Indexes**
  --
  idx_users_email
  idx_users_is_active
  idx_users_diet
  idx_users_profile_cooking_skill (JSONB)
  idx_users_favorite_cuisines (GIN)
  idx_users_disliked_ingredients (GIN)
}

entity "sessions" {
  **Primary Key**
  --
  * id : UUID <<PK>>
  --
  **Foreign Keys**
  --
  * user_id : UUID <<FK>>
  --
  **JSONB Columns**
  --
  * current_meal_plan : JSONB
    â”œâ”€ days[]
    â”‚  â”œâ”€ dayNumber
    â”‚  â””â”€ meals{}
    â”‚     â”œâ”€ breakfast
    â”‚     â”œâ”€ lunch
    â”‚     â””â”€ dinner
    â””â”€ nutritionSummary{}
       â”œâ”€ avgDailyCalories
       â””â”€ avgProtein
  --
  * modifications : JSONB[]
    â”œâ”€ timestamp
    â”œâ”€ action
    â”œâ”€ mealId
    â””â”€ reason
  --
  * temporary_constraints : JSONB[]
  --
  **Status**
  --
  * status : TEXT
    Values: 'active', 'confirmed',
            'expired', 'cancelled'
  --
  **Timestamps (TEXT)**
  --
  created_at : TEXT (ISO 8601)
  updated_at : TEXT (ISO 8601)
  expires_at : TEXT (ISO 8601)
  --
  **Indexes**
  --
  idx_sessions_user_id
  idx_sessions_status
  idx_sessions_expires_at
  idx_sessions_modifications (GIN)
}

entity "meal_plans" {
  **Primary Key**
  --
  * id : UUID <<PK>>
  --
  **Foreign Keys**
  --
  * user_id : UUID <<FK>>
  * session_id : UUID <<FK>> (nullable)
  --
  **JSONB Column**
  --
  * plan : JSONB
    â””â”€ (Same structure as
       sessions.current_meal_plan)
  --
  **Metadata**
  --
  plan_name : TEXT (nullable)
  number_of_days : INTEGER
  * status : TEXT
    Values: 'active', 'completed',
            'cancelled'
  --
  **Timestamps**
  --
  confirmed_at : TIMESTAMPTZ
  created_at : TIMESTAMPTZ
  --
  **Indexes**
  --
  idx_meal_plans_user_id
  idx_meal_plans_session_id
  idx_meal_plans_created_at
  idx_meal_plans_status
}

' Relationships
users ||--o{ sessions : "has many"
users ||--o{ meal_plans : "has many"
sessions ||--o| meal_plans : "may have"

note right of users
  **CASCADE Rules:**
  When user deleted:
  â€¢ All sessions deleted (CASCADE)
  â€¢ All meal_plans deleted (CASCADE)
  
  **RLS (Row Level Security):**
  Users can only access their own data
  
  **Soft Delete:**
  is_active = false (keeps data)
  Hard delete available for GDPR
end note

note right of sessions
  **Expiration:**
  Auto-expires after 7 days
  
  **Cleanup:**
  Cron job removes expired sessions
  
  **Purpose:**
  Temporary working storage
  for meal plan generation
end note

note right of meal_plans
  **Purpose:**
  Permanent storage of confirmed
  meal plans (user's history)
  
  **Relationship:**
  Links back to session that
  created it (for audit trail)
end note

legend right
  **Database: Supabase (PostgreSQL)**
  
  **Key Design Decisions:**
  â€¢ JSONB for flexibility
  â€¢ String timestamps for consistency
  â€¢ GIN indexes for array queries
  â€¢ CASCADE deletes for cleanup
  â€¢ Hard delete for GDPR compliance
  
  **File Location:**
  ğŸ“ src/database/
     supabase-schema-aligned.sql
endlegend

@enduml
